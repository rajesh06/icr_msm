# Applying the Model

We now have all the component models to develop our estimates. We start by generating generating test data. We use the same approach as we used to generate the model used to parameterize the model with the exception of the simulation seed.

We then "cutoff" the data so that we only have information trough a particular valuation date. (We use the same code that we presented in Section 2.2 except to applying an additional filter to exclude any observations valued after year-end 2005).

```{r echo=FALSE}
test_data <- readRDS(file = './data/test_data.RDS')

paid_data <- test_data %>%  
  dplyr::select(ClNr:RepDel, dplyr::starts_with('Pay')) %>% #keep IDs and payment amounts
  tidyr::pivot_longer(cols = Pay00:Pay11, names_to = 'paid_as_of', #wide to long
    values_to = 'paid') %>% 
  dplyr::mutate(maturity = stringr::str_extract(string = paid_as_of, #extract maturity
    pattern = '[0-9]{2}')) %>%
  #calculate cumulative payments
  dplyr::group_by(ClNr) %>% mutate(cum_paid = cumsum(paid)) %>% 
  dplyr::select(-paid)

status_data <- test_data %>%  #read the data
  dplyr::select(ClNr:RepDel, dplyr::starts_with('Open')) %>% #keep IDs and status
  tidyr::pivot_longer(cols = Open00:Open11, names_to = 'status_as_of', #wide to long
    values_to = 'status') %>% 
  dplyr::mutate(maturity = stringr::str_extract(string = status_as_of, #extract maturity
    pattern = '[0-9]{2}'))

test_data_2005 <- dplyr::left_join(paid_data, status_data) %>% #join paid and status data
  dplyr::select(-c(paid_as_of, status_as_of, LoB, age, cc, AQ, inj_part, RepDel)) %>%  #remove fields not used
  dplyr::mutate(maturity = as.numeric(maturity) + 1) %>% 
  dplyr::mutate(val_year = AY + maturity - 1) %>% 
  dplyr::filter(val_year <= 2005)

rm(paid_data, status_data) #cleanup

```
We present the familiar data triangle below.
```{r triangle}
table(test_data_2005$AY, test_data_2005$maturity)
```

The following table presents the number of open (`status == 1`) and closed (`status == 0`) claims at the current valuation (year-end 2005).

```{r}
val_2005 <- test_data_2005 %>% 
  dplyr::filter(val_year == 2005)
table(val_2005$AY, val_2005$status)
```

We now create the dataset for the simulation model.

```{r echo=TRUE}

sim_claims <- val_2005 %>%
  dplyr::filter(AY > 1994) %>%  # 1994 is at ultimate
  dplyr::mutate(mtm_code = case_when(
    status == 1 & cum_paid == 0 ~ "oz",
    status == 1 & cum_paid > 0 ~ "onz",
    status == 0 & cum_paid == 0 ~ "cz",
    status == 0 & cum_paid > 0 ~ "cnz",)) %>% #assign mtm_code
  dplyr::mutate(
    mtm_code_with_mat = paste(mtm_code, maturity, sep = '_'))

```

We use the function `open_sim` from the accompanying `R` package. For our case study we run 100 iterations (to keep computing time reasonable) for each claim. There are two inputs to the `open_sim` function, the first is the identifier for each claim in the database of open claims, in this case study that is the `ClNr` field of our `open_claims` database. The next input for the function is the last maturity of the transition matrix which in this case study is 12. 

```{r echo=TRUE, message=FALSE, warning=FALSE}

set.seed(14159) #for reproducibility
my_iters = 100
last_mat = 12 #last maturity

results <- lapply(X = sim_claims$ClNr, FUN = claims_simulation, last_mat)

names(results) <- paste0('claim_', sim_claims$ClNr)

#rm(mtm_selections)

```

After running the simulation we produce a `list` of each open claim and the 1,000 iterations of the closing states. The following code allows you to view the individual claims and their simulated output. 


We are looking at the first 5 simulations for claim number 5801 which is the 600th element in the list we created. If we look at the first iteration, we can see the claim went to open non zero at lag 1 and eventually closed non zero at lag 7. For the second iteration the claim stayed open zero until lag 3 where it changed to open non zero and eventually closed non zero at lag 6. Having the ability to view the simulation this closely allows you to drill down into each individual claim which is a resourceful tool when explaining results.

```{r}
results$claim_5801[1:5,]

```


