Section 2.4 will discuss creating the Markov Transition Matrices based on the observed data and incorporating acutarial judgement into selecting transition probabilities.

Together with the matrices containing the transitions between lags, we need a terminal matrix. The terminal matrix is determined after the claims development cylce is complete. A complete claims development cycle will “wash, rinse, repeat” until we reach ultimate.  (Pr(closed -> closed) = 1, Pr (open -> closed) = 1). The code to create the terminal matrix is below.

```{r echo=TRUE, eval=FALSE}
term_mat <- expand.grid(from = markov_states, to = markov_states) %>%
  dplyr::mutate(n = case_when(
    from == 'oz' & to == 'cz' ~ 1,
    from == 'onz' & to == 'cnz' ~ 1,
    from == 'cz' & to == 'cz' ~ 1,
    from == 'cnz' & to == 'cnz' ~ 1,
    TRUE ~ 0
  ))

zero_mat <- term_mat %>% 
  dplyr::mutate(n = 0)

```

Next, we use the matrices created in Section 2.2 and transform them from transition counts to transition probabilities.

```{r echo=TRUE, eval=FALSE}

mtm_selections <- lapply(mtms, function(x){
  mtm_prop <- (x %>% prop.table(margin = 1))
  
  return(mtm_prop)
})

mtm_selections[[length(mtm_selections) + 1]] <- term_mat

```

The above code generates the transition probabilities based solely on the observations in the data. We will now discuss applying selections to override the transition probabilities generated through the mtm function contained in the `R` package. There are numerous reasons for wanting to override the observed probabilities. In this Section we will discuss a select few.

In many instances, the data used to create the Markov Transition Matrices may sometimes show "re-openings" where a claim goes from a closed state to an open state. When modeling the data you may want to elimnate the probability of a re-opening. For our case study we chose to remove the probability of claim re-openings and thus set our selections to support this decision. After viewing the matrices produced below we updated the selections for any occurence of a closed state transitioning to an open state. The selections are updated as follows:

```{r echo=TRUE, eval=FALSE}

#Transition 1 - 2
mtm_selections[[1]] <- update_mtm_selection(mtm_selections[[1]], 
                                            from = 'cz', to = 'cz', selection = 1)
mtm_selections[[1]] <- update_mtm_selection(mtm_selections[[1]], 
                                            from = 'cz', to = 'onz', selection = 0)
mtm_selections[[1]] <- update_mtm_selection(mtm_selections[[1]], 
                                            from = 'cnz', to = 'cnz', selection = 1)
mtm_selections[[1]] <- update_mtm_selection(mtm_selections[[1]], 
                                            from = 'cnz', to = 'onz', selection = 0)


#Transition 2 - 3
mtm_selections[[2]] <- update_mtm_selection(mtm_selections[[2]], 
                                            from = 'cz', to = 'cz', selection = 1)
mtm_selections[[2]] <- update_mtm_selection(mtm_selections[[2]], 
                                            from = 'cz', to = 'onz', selection = 0)
mtm_selections[[2]] <- update_mtm_selection(mtm_selections[[2]], 
                                            from = 'cz', to = 'oz', selection = 0)
mtm_selections[[2]] <- update_mtm_selection(mtm_selections[[2]], 
                                            from = 'cnz', to = 'cnz', selection = 1)
mtm_selections[[2]] <- update_mtm_selection(mtm_selections[[2]], 
                                            from = 'cnz', to = 'onz', selection = 0)

#Transition 3 - 4
mtm_selections[[3]] <- update_mtm_selection(mtm_selections[[3]], 
                                            from = 'cnz', to = 'cnz', selection = 1)
mtm_selections[[3]] <- update_mtm_selection(mtm_selections[[3]], 
                                            from = 'cnz', to = 'onz', selection = 0)
```

Another example of an instance where you would want to override an observed probability would be to smooth the transitions between lags. Looking at our transition matrices produced below we note that in lag five to six, 60% of oz claims transition to onz and 40% stay oz. In the next few lags 100% of oz claims stay oz. We have selected to smooth this transition by modifying lags 6-7 and 7-8 as follows:

```{r echo=TRUE, eval=FALSE}

#Transition 6 - 7
mtm_selections[[6]] <- update_mtm_selection(mtm_selections[[6]], 
                                            from = 'oz', to = 'onz', selection = .4)
mtm_selections[[6]] <- update_mtm_selection(mtm_selections[[6]], 
                                            from = 'oz', to = 'oz', selection = .6)
#Transition 7 - 8
mtm_selections[[7]] <- update_mtm_selection(mtm_selections[[7]], 
                                            from = 'oz', to = 'onz', selection = .2)
mtm_selections[[7]] <- update_mtm_selection(mtm_selections[[7]], 
                                            from = 'oz', to = 'oz', selection = .8)

```

After reviewing our Markov Transition Matrices we also noticed that for lag 1 the synthetic data had a very low probability of either closing with no value or staying open with no value. We wanted to adjust for this and give claims an opportunity to either stay open zero or close zero at this early transition. 

```{r echo=TRUE, eval=FALSE}
#Transition 1 - 2
mtm_selections[[1]] <- update_mtm_selection(mtm_selections[[1]], 
                                            from = 'oz', to = 'cz', selection = .45)
mtm_selections[[1]] <- update_mtm_selection(mtm_selections[[1]], 
                                            from = 'oz', to = 'cnz', selection = .05)
mtm_selections[[1]] <- update_mtm_selection(mtm_selections[[1]], 
                                            from = 'oz', to = 'oz', selection = .4)
mtm_selections[[1]] <- update_mtm_selection(mtm_selections[[1]], 
                                            from = 'oz', to = 'onz', selection = .1)

```                                           
                                            
As noted above, there are several other reasons for overriding the observed probability that would be reasonable depending on the data and the end results of the model.

We visualize the matrices by creating a "for" loop for all of the transitions in the matrix and using the function "plot_mtms" from the accompanying R package. The probabilities are visualized on a gradiant, the darker the blue the higher the probability of the transition.

**AT - having trouble figuring out how to load these matrices, also - do we want to show all or just the ones we change selections for?
```{r echo=TRUE, eval=FALSE}

#plot mtms
for(i in 1:length(mtms)){
  
  #i = 1
  t_plot <- plot_mtm(i)
  
  win.metafile(filename = paste0(
    here::here('paper/output/mtm_'),i, "_to_", i + 1,".wmf"), #save out visual of matrices
    width = 10, height = 6)
  
  plot(t_plot)
  dev.off()
}

win.metafile(filename = 
               paste0(here::here('paper/output/mtm_terminal.wmf')), #save out terminal matrix
             width = 10, height = 6)

plot(plot_mtm('terminal'))
dev.off()

rm(t_plot, term_mat, zero_mat, i, markov_states, transitions) #cleanup

```