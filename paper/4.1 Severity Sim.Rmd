The final step is to append the severity values to each data frame


```{r functions}
extract_no_add_pay_rate <- function(df){
    #df <- test_claim #testing
  sapply(X = 1:nrow(df), FUN = function(row_no){
    #row_no <- 9 #testing
    cum_pd <- df$cum_paid[row_no] #cum_pd
    car_df <- df$no_add_pay[row_no][[1]] #car_df
    car_pr <- car_df$no_add_pay_rate[sum(cum_pd > car_df$layer_start)]
    if(is.null(car_pr)) car_pr <- 1
    return(car_pr)
  }, simplify = TRUE) %>% unlist()
}

sim_sev <- function(cum_paid, lt10_model, gt10_model, z_model) {
  
  #cum_paid <- 28133
  #lt10_model <- test_claim$nz_lt_10[[1]]
  my_newdata <- data.frame('cum_paid' = cum_paid)
  my_predicted <- predict.glm(object = lt10_model, newdata = my_newdata)
  shape <- MASS::gamma.shape(lt10_model)$alpha
  sim_lt10 <- rgamma(n = 1, shape = shape, rate = shape/my_predicted) %>% exp()
  
  #gt10_model <- test_claim$nz_gt_10[[13]]
  my_sd_log <- summary(gt10_model)$sigma
  if(is.nan(my_sd_log)) my_sd_log <- 0
  sim_gt10 <- rlnorm(n = 1, meanlog = predict.lm(object = gt10_model, 
    newdata = my_newdata), sdlog = summary(gt10_model)$sigma)
  
  #z_model <- test_claim$z_dev[[1]]
  z_sim <- sample(z_model, size = 1) %>% exp()
  
  val_to_return <- dplyr::case_when(
    cum_paid == 0 ~ z_sim,
    cum_paid > 0 & cum_paid < exp(10) ~ sim_lt10,
    cum_paid >= exp(10) ~ sim_gt10)
  
  return(val_to_return)
}

```

In the code below, we follow the following recipe in simulating severity values.

* For each claim, we first retain only those fields that we will need.
* We then `join` our severity model dataframe. This step adds dataframe columns.
* Recall that the model for no additional payments required a lookup from a dataframe of empirical values. We use the `extract_no_add_pay_rate` function to perform that lookup. If a closed claim does not reopen, we assign a 100% probability on no new claims. We then then sample from a uniform distribution to model additional payments.
* We feed the various component models and the paid value into the `sim_sev` function. That function returns the severity value resulting from the applicable severity model. We then only use that value if the claim has simulated as having additional payment.


```{r message=FALSE, warning=FALSE}
#results <- results_orig
results <- lapply(X = names(results), FUN = function(claim){
  
  #claim <- 'claim_472'
  #print(claim)
  
  df <- results[claim][[1]]  # extract the data frame
  
  test_claim <- df %>% 
    dplyr::select(ClNr, final_state, lag_to_close = settle_lag) %>% 
    dplyr::left_join(severity_model_df) %>% 
    dplyr::left_join(dplyr::select(val_2005, ClNr, AY, cum_paid)) %>% 
    dplyr::mutate(gt10 = cum_paid > exp(10))
  
  no_add_pay_rate <- extract_no_add_pay_rate(test_claim)
  
  no_add_pay_rate2 <- sapply(X = 1:nrow(test_claim), FUN = function(row_no){
    #row_no <- 9
    never_open <- test_claim$lag_to_close == 0
    if (never_open[row_no]) {
      1
    } else {
      no_add_pay_rate[row_no]
    }
  }, simplify = TRUE)
  
  
  test_claim <- test_claim %>% 
    dplyr::mutate(no_add_pay_rate = no_add_pay_rate2) %>% 
    dplyr::mutate(no_add_pay_rv = runif(n = nrow(test_claim))) %>% 
    dplyr::mutate(no_add_pay = no_add_pay_rv < no_add_pay_rate)
  
  sevs <- sapply(X = 1:nrow(test_claim), FUN = function(row_no){
    #row_no <- 88
    #print(row_no)
    if(test_claim$lag_to_close[row_no] > 0) {
      
      sim_sev(cum_paid = test_claim$cum_paid[row_no], 
        lt10_model = test_claim$nz_lt_10[[row_no]],
        gt10_model = test_claim$nz_gt_10[[row_no]], 
        z_model = test_claim$z_dev[[row_no]]
      )} else {
        test_claim$cum_paid[row_no]
      }
  }, 
    simplify = TRUE)
  
  sevs <- pmax(test_claim$cum_paid, sevs)
  
  test_claim <- test_claim %>% 
    dplyr::mutate(sim_sev = sevs) %>% 
    dplyr::mutate(final_sim_sev = dplyr::case_when(
      no_add_pay | lag_to_close == 0 ~ cum_paid,
      TRUE ~ sim_sev
    ))
  
  return(test_claim)
})

```  


```{r}
results_df <- dplyr::bind_rows(results) %>% 
  dplyr::select(ClNr, AY, cum_paid, final_sim_sev) %>% 
  dplyr::group_by(ClNr) %>% 
  dplyr::mutate(iter_no = 1:my_iters)
```


```{r}
ultimates <- test_data %>% 
  dplyr::mutate(ultimate = Pay00 + Pay01 + Pay02 + Pay03 + Pay04 + Pay05 +
    Pay06 +  Pay07 + Pay08 +  Pay09 + Pay10 + Pay11) %>% 
  dplyr::select(ClNr, ultimate) 

paid_2005 <- test_data_2005 %>% 
  dplyr::filter(val_year == 2005) %>% 
  dplyr::select(ClNr, AY, paid_2005 = cum_paid) 

actual <- ultimates %>% 
  dplyr::left_join(paid_2005) %>% 
  dplyr::group_by(AY) %>% 
  summarise(paid_2005 = sum(paid_2005), ultimate = sum(ultimate))
actual

```

```{r}
results_df2 <- results_df %>% 
  dplyr::left_join(dplyr::select(paid_2005, ClNr, AY)) %>% 
  dplyr::group_by(iter_no, AY) %>% 
  dplyr::summarise(sim_ult = sum(final_sim_sev))
results_df2

results_df2 <- results_df %>% 
  dplyr::left_join(dplyr::select(paid_2005, ClNr, AY)) %>% 
  dplyr::group_by(AY) %>% 
  dplyr::summarise(sim_ult = sum(final_sim_sev) / 1000)
```

```{r}
lapply(X = 1995:2005, FUN = function(ay){
  results_df %>% 
    dplyr::filter(AY == ay) %>% 
    dplyr::group_by(iter_no) %>% 
    dplyr::summarise(sim_ult = sum(final_sim_sev)) %>% 
    dplyr::pull(sim_ult) %>% 
    hist(main = ay)
  
  abline(v = actual$ultimate[actual$AY == ay], col = 'red')
  abline(v = actual$paid_2005[actual$AY == ay], col = 'blue')
})

```




